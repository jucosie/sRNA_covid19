---
title: "tRNA analysis"
author: "Julia Corell Sierra"
date: '2023-01-13'
output: html_document
---

```{r}
library(tidyverse)
library(ComplexHeatmap)
library(circlize)
library(DESeq2)
library(ggrepel)
library(ggbreak)
library(ggpubr)
```

```{r}
padj.cutoff <- 0.05
anno_file <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/06-Annotation/Annotation/curated_unitas_withtiny_annotation.tsv", sep="\t", header=TRUE)
RPMs_table <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/03-Fusion_tables/Filtered_RPMs-outer_filt5.tsv", sep="\t", header = TRUE)
sampletable <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Additional_data/samplesheet.tsv", header=T, sep="\t")
DE_T1_acute <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/07-DE/DE_results/results_DE_T1acute.tsv", sep="\t", header=TRUE)
DE_T1_acute_sig <- DE_T1_acute %>%
  dplyr::filter(padj < padj.cutoff)
DE_T1_mild <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/07-DE/DE_results/results_DE_T1mild.tsv", sep="\t", header=TRUE)
DE_T1_mild_sig <- DE_T1_mild %>%
  dplyr::filter(padj < padj.cutoff)
DE_T2_acute <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/07-DE/DE_results/results_DE_T2acute.tsv", sep="\t", header=TRUE)
DE_T2_acute_sig <- DE_T2_acute %>%
  dplyr::filter(padj < padj.cutoff)
DE_T2_mild <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/07-DE/DE_results/results_DE_T2mild.tsv", sep="\t", header=TRUE)
DE_T2_mild_sig <- DE_T2_mild %>%
  dplyr::filter(padj < padj.cutoff)

DE_T1_acute_sig_ann <- merge(DE_T1_acute_sig, anno_file, by.x = "seq", by.y = "Seq", all.x = TRUE)
DE_T1_mild_sig_ann <-  merge(DE_T1_mild_sig, anno_file, by.x = "seq", by.y = "Seq", all.x = TRUE)
DE_T2_acute_sig_ann <- merge(DE_T2_acute_sig, anno_file, by.x = "seq", by.y = "Seq", all.x = TRUE)
DE_T2_mild_sig_ann <-  merge(DE_T2_mild_sig, anno_file, by.x = "seq", by.y = "Seq", all.x = TRUE)
```


```{r}
DE_T1_acute_tRNA <- DE_T1_acute_sig_ann %>%
  dplyr::filter(grepl("tRNA", DE_T1_acute_sig_ann$RNA_class))

DE_T1_mild_tRNA <- DE_T1_mild_sig_ann %>%
  dplyr::filter(grepl("tRNA", DE_T1_mild_sig_ann$RNA_class))

DE_T2_acute_tRNA <- DE_T2_acute_sig_ann %>%
  dplyr::filter(grepl("tRNA", DE_T2_acute_sig_ann$RNA_class))

DE_T2_mild_tRNA <- DE_T2_mild_sig_ann %>%
  dplyr::filter(grepl("tRNA", DE_T2_mild_sig_ann$RNA_class))

DE_tRNAs <- Reduce (union, list(DE_T1_acute_tRNA$seq, DE_T1_mild_tRNA$seq, DE_T2_acute_tRNA$seq, DE_T2_mild_tRNA$seq))
```

```{r}
DE_tRNAs_df <- subset(RPMs_table, RPMs_table$seq %in% DE_tRNAs)
DE_tRNAs_df_ann <- merge(DE_tRNAs_df, anno_file, by.x="seq", by.y="Seq", all.x=TRUE)
DE_tRNAs_df_ann <- DE_tRNAs_df_ann[,-which(names(DE_tRNAs_df_ann) %in% c("Length", "RNA_class", "Position"))]
colnames(DE_tRNAs_df_ann) <- gsub("\\.", "-", colnames(DE_tRNAs_df_ann))
colnames(DE_tRNAs_df_ann) <- gsub("T0_", "", colnames(DE_tRNAs_df_ann))
```

### Heatmaps

Heatmap annotation.
```{r}
ann <- data.frame(sampletable$Group)
colnames(ann) <- c('Group')
colours <- list('Group' = c('T0_control' = "#00468BB2", 'T1_acute' = "#da6a65", "T1_mild"= "lightgreen", "T2_acute" = "#ED0000B2", "T2_mild" = "darkgreen"))
colAnn <- HeatmapAnnotation(df = ann,
  which = 'col',
  col = colours,
  annotation_width = unit(c(1, 4), 'cm'),
  gap = unit(1, 'mm'),
  show_legend = FALSE)

myCol = colorRampPalette(c('dodgerblue', 'black', 'yellow'))(100)
myBreaks = seq(-3, 3, length.out = 100)
zscore_col_fun = colorRamp2(myBreaks, myCol)
```

#### 5p-tR-half

```{r}
DE_5p_tRhalf <- DE_tRNAs_df_ann %>%
  dplyr::filter(grepl("5p-tR-half", DE_tRNAs_df_ann$tRNA_class))

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_5p_tRhalf$ID_DB_cut <- str_replace(DE_5p_tRhalf$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_5p_tRhalf_grouped <- DE_5p_tRhalf[,-which(names(DE_5p_tRhalf) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_5p-tR-half.png", height = 20, width = 25, res = 1200,units = "cm")
scaled_matrix_DE_5p_tRhalf_grouped <- t(scale(t(DE_5p_tRhalf_grouped)))
ht_1 <- Heatmap(as.matrix(scaled_matrix_DE_5p_tRhalf_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="5p-tR-half",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE,
        column_km=5)
draw(ht_1)
dev.off()
```
#### 3p-tR-half

```{r}
DE_3p_tRhalf <- DE_tRNAs_df_ann %>%
  dplyr::filter(grepl("3p-tR-half", DE_tRNAs_df_ann$tRNA_class))

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_3p_tRhalf$ID_DB_cut <- str_replace(DE_3p_tRhalf$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_3p_tRhalf_grouped <- DE_3p_tRhalf[,-which(names(DE_3p_tRhalf) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_3p-tR-half.png", height = 20, width = 25, res = 1200,units = "cm")
scaled_matrix_DE_3p_tRhalf_grouped <- t(scale(t(DE_3p_tRhalf_grouped)))
ht_2 <- Heatmap(as.matrix(scaled_matrix_DE_3p_tRhalf_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="3p-tR-half",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_2)
dev.off()
```
#### 5p-tRF
```{r}
DE_5p_tRF <- DE_tRNAs_df_ann %>%
  dplyr::filter(grepl("5p-tRF", DE_tRNAs_df_ann$tRNA_class))

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_5p_tRF$ID_DB_cut <- str_replace(DE_5p_tRF$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_5p_tRF_grouped <- DE_5p_tRF[,-which(names(DE_5p_tRF) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_5p-tRF.png", height = 20, width = 25, res = 1200,units = "cm")
scaled_matrix_DE_5p_tRF_grouped <- t(scale(t(DE_5p_tRF_grouped)))
ht_3 <- Heatmap(as.matrix(scaled_matrix_DE_5p_tRF_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="5p-tRF",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_3)
dev.off()
```

#### 3p-tRF

```{r}
DE_3p_tRF <- DE_tRNAs_df_ann %>%
  dplyr::filter(grepl("3p-tRF|3p-CCA-tRF", DE_tRNAs_df_ann$tRNA_class))

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_3p_tRF$ID_DB_cut <- str_replace(DE_3p_tRF$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_3p_tRF_grouped <- DE_3p_tRF[,-which(names(DE_3p_tRF) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_3p-tRF.png", height = 20, width = 25, res = 1200,units = "cm")
scaled_matrix_DE_3p_tRF_grouped <- t(scale(t(DE_3p_tRF_grouped)))
ht_4 <- Heatmap(as.matrix(scaled_matrix_DE_3p_tRF_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="3p-tRF",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_4)
dev.off()
```

#### baseMean > 100

```{r}
load("/home/ultramind/Disco2/SARS_sRNA_paper/Results/07-DE/DESeq_object.RData")
norm_counts <- assay(vst(dds_2))
normalized_counts <- t(scale(t(norm_counts)))
normalized_counts <- normalized_counts %>%
                     data.frame() %>%
                     tibble::rownames_to_column(var="seq")
# normalized_counts <- counts(dds_2, normalized=T) %>% 
#                      data.frame() %>%
#                      tibble::rownames_to_column(var="seq")
# 
# colnames(normalized_counts) <- gsub("\\.", "-", colnames(normalized_counts))
# colnames(normalized_counts) <- gsub("T0_", "", colnames(normalized_counts))

DE_tRNAs_df <- subset(normalized_counts, normalized_counts$seq %in% DE_tRNAs)
DE_tRNAs_df_ann <- merge(DE_tRNAs_df, anno_file, by.x="seq", by.y="Seq", all.x=TRUE)
DE_tRNAs_df_ann <- DE_tRNAs_df_ann[,-which(names(DE_tRNAs_df_ann) %in% c("Length", "RNA_class", "Position"))]
```

```{r}
DE_T1_acute_tRNA_100 <- DE_T1_acute_tRNA %>%
  dplyr::filter(baseMean >= 100)
DE_T1_mild_tRNA_100 <- DE_T1_mild_tRNA %>%
  dplyr::filter(baseMean >= 100)
DE_T2_acute_tRNA_100 <- DE_T2_acute_tRNA %>%
  dplyr::filter(baseMean >= 100)
DE_T2_mild_tRNA_100 <- DE_T2_mild_tRNA %>%
  dplyr::filter(baseMean >= 100)

DE_tRNAs_100 <- Reduce(union, list(DE_T1_acute_tRNA_100$seq, DE_T1_mild_tRNA_100$seq, DE_T2_acute_tRNA_100$seq, DE_T2_mild_tRNA_100$seq))
```

Colors and annotation

```{r}
ann <- data.frame(sampletable$Group)
colnames(ann) <- c('Group')
colours <- list('Group' = c('T0_control' = "#00468BB2", 'T1_acute' = "#da6a65", "T1_mild"= "lightgreen", "T2_acute" = "#ED0000B2", "T2_mild" = "darkgreen"))
colAnn <- HeatmapAnnotation(df = ann,
  which = 'col',
  col = colours,
  annotation_width = unit(c(1, 4), 'cm'),
  gap = unit(1, 'mm'),
  show_legend = FALSE)

myCol = colorRampPalette(c('blue', 'white', 'red'))(100)
myBreaks = seq(-3, 3, length.out = 100)
zscore_col_fun = colorRamp2(myBreaks, myCol)
```

```{r}
DE_5p_tRhalf_100 <- DE_tRNAs_df_ann  %>%
  dplyr::filter(grepl("5p-tR-half", DE_tRNAs_df_ann$tRNA_class))

DE_5p_tRhalf_100 <- DE_5p_tRhalf_100[DE_5p_tRhalf_100$seq %in% DE_tRNAs_100,]

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_5p_tRhalf_100$ID_DB_cut <- str_replace(DE_5p_tRhalf_100$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_5p_tRhalf_100_grouped <- DE_5p_tRhalf_100[,-which(names(DE_5p_tRhalf_100) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_5p-tR-half_100_vst.png", height = 20, width = 25, res = 1200,units = "cm")
#scaled_matrix_DE_5p_tRhalf_100_grouped <- t(scale(t(DE_5p_tRhalf_100_grouped)))
ht_5 <- Heatmap(as.matrix(DE_5p_tRhalf_100_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="5p-tR-half",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_5)
dev.off()
```
```{r}
DE_3p_tRhalf_100 <- DE_tRNAs_df_ann  %>%
  dplyr::filter(grepl("3p-tR-half", DE_tRNAs_df_ann$tRNA_class))

DE_3p_tRhalf_100 <- DE_3p_tRhalf_100[DE_3p_tRhalf_100$seq %in% DE_tRNAs_100,]

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_3p_tRhalf_100$ID_DB_cut <- str_replace(DE_3p_tRhalf_100$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_3p_tRhalf_100_grouped <- DE_3p_tRhalf_100[,-which(names(DE_3p_tRhalf_100) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_3p-tR-half_100_vst.png", height = 20, width = 25, res = 1200,units = "cm")
scaled_matrix_DE_3p_tRhalf_100_grouped <- t(scale(t(DE_3p_tRhalf_100_grouped)))
ht_6 <- Heatmap(as.matrix(scaled_matrix_DE_3p_tRhalf_100_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="3p-tR-half",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_6)
dev.off()
```

```{r}
DE_5p_tRF_100 <- DE_tRNAs_df_ann  %>%
  dplyr::filter(grepl("5p-tRF", DE_tRNAs_df_ann$tRNA_class))

DE_5p_tRF_100 <- DE_5p_tRF_100[DE_5p_tRF_100$seq %in% DE_tRNAs_100,]

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_5p_tRF_100$ID_DB_cut <- str_replace(DE_5p_tRF_100$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_5p_tRF_100_grouped <- DE_5p_tRF_100[,-which(names(DE_5p_tRF_100) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_5p-tRF_100_vst.png", height = 20, width = 25, res = 1200,units = "cm")
#scaled_matrix_DE_5p_tRF_100_grouped <- t(scale(t(DE_5p_tRF_100_grouped)))
ht_7 <- Heatmap(as.matrix(DE_5p_tRF_100_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="5p-tRF",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_7)
dev.off()
```
```{r}
DE_3p_tRF_100 <- DE_tRNAs_df_ann  %>%
  dplyr::filter(grepl("3p-tRF", DE_tRNAs_df_ann$tRNA_class))

DE_3p_tRF_100 <- DE_3p_tRF_100[DE_3p_tRF_100$seq %in% DE_tRNAs_100,]

## We saw that we don't have the confidence to annotate at isodecoder level, so let's remove anticodon and isodecode
DE_3p_tRF_100$ID_DB_cut <- str_replace(DE_3p_tRF_100$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

## Group 

DE_3p_tRF_100_grouped <- DE_3p_tRF_100[,-which(names(DE_3p_tRF_100) %in% c("seq","ID", "RNA_ID", "tRNA_class"))] %>%
  group_by(ID_DB_cut) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames(var = "ID_DB_cut")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/heatmap_3p-tRF_100_vst.png", height = 20, width = 25, res = 1200,units = "cm")
#scaled_matrix_DE_3p_tRF_100_grouped <- t(scale(t(DE_3p_tRF_100_grouped)))
ht_8 <- Heatmap(as.matrix(DE_3p_tRF_100_grouped),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="3p-tRF",
        top_annotation=colAnn,
        show_heatmap_legend = TRUE)
draw(ht_8)
dev.off()
```



***

#### 2nd try

Let's take a look at the tRNA sequences behavior.

```{r}
DE_T1_acute_tRNA$ID_DB_cut <- str_replace(DE_T1_acute_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T1_acute_tRNA <- DE_T1_acute_tRNA %>%
  filter(!grepl("MT", DE_T1_acute_tRNA$ID_DB_cut))

DE_T2_acute_tRNA$ID_DB_cut <- str_replace(DE_T2_acute_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T2_acute_tRNA <- DE_T2_acute_tRNA %>%
  filter(!grepl("MT", DE_T2_acute_tRNA$ID_DB_cut))

DE_T1_mild_tRNA$ID_DB_cut <- str_replace(DE_T1_mild_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T1_mild_tRNA <- DE_T1_mild_tRNA %>%
  filter(!grepl("MT", DE_T1_mild_tRNA$ID_DB_cut))

DE_T2_mild_tRNA$ID_DB_cut <- str_replace(DE_T2_mild_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T2_mild_tRNA <- DE_T2_mild_tRNA %>%
  filter(!grepl("MT", DE_T2_mild_tRNA$ID_DB_cut))

aa_list <- Reduce(union, list(DE_T1_acute_tRNA$ID_DB_cut, DE_T1_mild_tRNA$ID_DB_cut, DE_T2_acute_tRNA$ID_DB_cut, DE_T2_mild_tRNA$ID_DB_cut))
aa_list <- sort(aa_list)
```

```{r}
DE_T1_acute_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T1_acute_tRNA$tRNA_class), "3p-tRF", DE_T1_acute_tRNA$tRNA_class)

DE_T1_acute_tRNA$ID_DB_cut <- factor(DE_T1_acute_tRNA$ID_DB_cut, levels= aa_list)

##Alternative plot without misc-tRF and tRF-1
DE_T1_acute_tRNA <- DE_T1_acute_tRNA %>%
  filter(!grepl("tRF-1|misc-tRF", DE_T1_acute_tRNA$tRNA_class))
##

ggplot(DE_T1_acute_tRNA, aes(x=ID_DB_cut, y=lfcShrunk)) +
  geom_boxplot(outlier.shape=NA, fill="#da6a65", alpha=0.7) +
  geom_jitter(size=2, alpha=0.7, aes(shape= tRNA_class)) +
  scale_shape_manual(values=c(17,19,2,1,8,5)) +
  scale_x_discrete(drop=FALSE) +
  theme_bw() +
  geom_hline(yintercept=0, color="black") +
  theme(#legend.position = "none",
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(color="black", angle=90, hjust = 1, vjust = 0.5),
    axis.text.y = element_text(color="black")) + ggtitle("Acute (T1) tRNA-derived expression") + ylab("Log2 fold change") +
  xlab("tRNA isotype")

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_acute_tRNAs_aa_exp_filt.png", height=5, width=15, dpi=600)
```
```{r}
summary_table_tRNA_T1acute <- data.frame(tRNA=rep(unique(DE_T1_acute_tRNA$ID_DB_cut), each=length(unique(DE_T1_acute_tRNA$tRNA_class))), 
                                         tRNA_type=rep(unique(DE_T1_acute_tRNA$tRNA_class), length(unique(DE_T1_acute_tRNA$ID_DB_cut))), 
                                                       Up="NA", Down="NA")
for (i in 1:nrow(summary_table_tRNA_T1acute)){
  summary_table_tRNA_T1acute$Up[i] <- nrow(DE_T1_acute_tRNA[DE_T1_acute_tRNA$ID_DB_cut==summary_table_tRNA_T1acute$tRNA[i] & 
                                                              DE_T1_acute_tRNA$tRNA_class==summary_table_tRNA_T1acute$tRNA_type[i] & 
                                                              DE_T1_acute_tRNA$lfcShrunk > 0,])
  summary_table_tRNA_T1acute$Down[i] <- nrow(DE_T1_acute_tRNA[DE_T1_acute_tRNA$ID_DB_cut==summary_table_tRNA_T1acute$tRNA[i] & 
                                                              DE_T1_acute_tRNA$tRNA_class==summary_table_tRNA_T1acute$tRNA_type[i] & 
                                                              DE_T1_acute_tRNA$lfcShrunk < 0,])
}
write.table(summary_table_tRNA_T1acute, "/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/summary_table_tRNA_T1_acute.tsv", sep="\t", row.names=FALSE)
```

```{r}
DE_T2_acute_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T2_acute_tRNA$tRNA_class), "3p-tRF", DE_T2_acute_tRNA$tRNA_class)

DE_T2_acute_tRNA$ID_DB_cut <- factor(DE_T2_acute_tRNA$ID_DB_cut, levels= aa_list)

##Alternative plot without misc-tRF and tRF-1
DE_T2_acute_tRNA <- DE_T2_acute_tRNA %>%
  filter(!grepl("tRF-1|misc-tRF", DE_T2_acute_tRNA$tRNA_class))
##

ggplot(DE_T2_acute_tRNA, aes(x=ID_DB_cut, y=lfcShrunk)) +
  geom_boxplot(outlier.shape=NA, fill="#ED0000B2", alpha=0.7) +
  geom_jitter(size=2, alpha=0.7, aes(shape= tRNA_class)) +
  scale_shape_manual(values=c(19,2,1,8,5)) +
  scale_x_discrete(drop=FALSE) +
  theme_bw() +
  geom_hline(yintercept=0, color="black") +
  theme(#legend.position = "none",
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(color="black", angle=90, hjust = 1, vjust = 0.5),
    axis.text.y = element_text(color="black")) + ggtitle("Acute (T2) tRNA-derived expression") + ylab("Log2 fold change") +
  xlab("tRNA isotype")

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_acute_tRNAs_aa_exp_filt.png", height=5, width=15, dpi=600)
```
```{r}
summary_table_tRNA_T2acute <- data.frame(tRNA=rep(unique(DE_T2_acute_tRNA$ID_DB_cut), each=length(unique(DE_T1_acute_tRNA$tRNA_class))), 
                                         tRNA_type=rep(unique(DE_T1_acute_tRNA$tRNA_class), length(unique(DE_T2_acute_tRNA$ID_DB_cut))), 
                                                       Up="NA", Down="NA")
for (i in 1:nrow(summary_table_tRNA_T2acute)){
  summary_table_tRNA_T2acute$Up[i] <- nrow(DE_T2_acute_tRNA[DE_T2_acute_tRNA$ID_DB_cut==summary_table_tRNA_T2acute$tRNA[i] & 
                                                              DE_T2_acute_tRNA$tRNA_class==summary_table_tRNA_T2acute$tRNA_type[i] & 
                                                              DE_T2_acute_tRNA$lfcShrunk > 0,])
  summary_table_tRNA_T2acute$Down[i] <- nrow(DE_T2_acute_tRNA[DE_T2_acute_tRNA$ID_DB_cut==summary_table_tRNA_T2acute$tRNA[i] & 
                                                              DE_T2_acute_tRNA$tRNA_class==summary_table_tRNA_T2acute$tRNA_type[i] & 
                                                              DE_T2_acute_tRNA$lfcShrunk < 0,])
}
write.table(summary_table_tRNA_T2acute, "/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/summary_table_tRNA_T2_acute.tsv", sep="\t", row.names=FALSE)
```

```{r}
DE_T1_mild_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T1_mild_tRNA$tRNA_class), "3p-tRF", DE_T1_mild_tRNA$tRNA_class)

DE_T1_mild_tRNA$ID_DB_cut <- factor(DE_T1_mild_tRNA$ID_DB_cut, levels= aa_list)

##Alternative plot without misc-tRF and tRF-1
DE_T1_mild_tRNA <- DE_T1_mild_tRNA %>%
  filter(!grepl("tRF-1|misc-tRF", DE_T1_mild_tRNA$tRNA_class))
##

ggplot(DE_T1_mild_tRNA, aes(x=ID_DB_cut, y=lfcShrunk)) +
  geom_boxplot(outlier.shape=NA, fill="lightgreen", alpha=0.7) +
  geom_jitter(size=2, alpha=0.7, aes(shape= tRNA_class)) +
  scale_shape_manual(values=c(19,2,1,8)) +
  scale_x_discrete(drop=FALSE) +
  theme_bw() +
  geom_hline(yintercept=0, color="black") +
  theme(#legend.position = "none",
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(color="black", angle=90, hjust = 1, vjust = 0.5),
    axis.text.y = element_text(color="black")) + ggtitle("Mild (T1) tRNA-derived expression") + ylab("Log2 fold change") +
  xlab("tRNA isotype")

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_mild_tRNAs_aa_exp_filt.png", height=5, width=15, dpi=600)
```
```{r}
summary_table_tRNA_T1mild <- data.frame(tRNA=rep(unique(DE_T1_mild_tRNA$ID_DB_cut), each=length(unique(DE_T1_acute_tRNA$tRNA_class))), 
                                         tRNA_type=rep(unique(DE_T1_acute_tRNA$tRNA_class), length(unique(DE_T1_mild_tRNA$ID_DB_cut))), 
                                                       Up="NA", Down="NA")
for (i in 1:nrow(summary_table_tRNA_T1mild)){
  summary_table_tRNA_T1mild$Up[i] <- nrow(DE_T1_mild_tRNA[DE_T1_mild_tRNA$ID_DB_cut==summary_table_tRNA_T1mild$tRNA[i] & 
                                                              DE_T1_mild_tRNA$tRNA_class==summary_table_tRNA_T1mild$tRNA_type[i] & 
                                                              DE_T1_mild_tRNA$lfcShrunk > 0,])
  summary_table_tRNA_T1mild$Down[i] <- nrow(DE_T1_mild_tRNA[DE_T1_mild_tRNA$ID_DB_cut==summary_table_tRNA_T1mild$tRNA[i] & 
                                                              DE_T1_mild_tRNA$tRNA_class==summary_table_tRNA_T1mild$tRNA_type[i] & 
                                                              DE_T1_mild_tRNA$lfcShrunk < 0,])
}
write.table(summary_table_tRNA_T1mild, "/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/summary_table_tRNA_T1_mild.tsv", sep="\t", row.names=FALSE)
```

```{r}
DE_T2_mild_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T2_mild_tRNA$tRNA_class), "3p-tRF", DE_T2_mild_tRNA$tRNA_class)

DE_T2_mild_tRNA$ID_DB_cut <- factor(DE_T2_mild_tRNA$ID_DB_cut, levels= aa_list)

##Alternative plot without misc-tRF and tRF-1
DE_T2_mild_tRNA <- DE_T2_mild_tRNA %>%
  filter(!grepl("tRF-1|misc-tRF", DE_T2_mild_tRNA$tRNA_class))
##

ggplot(DE_T2_mild_tRNA, aes(x=ID_DB_cut, y=lfcShrunk)) +
  geom_boxplot(outlier.shape=NA, fill="darkgreen", alpha=0.7) +
  geom_jitter(size=2, alpha=0.7, aes(shape= tRNA_class)) +
  scale_shape_manual(values=c(19,2,1,8)) +
  scale_x_discrete(drop=FALSE) +
  theme_bw() +
  geom_hline(yintercept=0, color="black") +
  theme(#legend.position = "none",
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_text(color="black", angle=90, hjust = 1, vjust = 0.5),
    axis.text.y = element_text(color="black")) + ggtitle("Mild (T2) tRNA-derived expression") + ylab("Log2 fold change") +
  xlab("tRNA isotype")

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_mild_tRNAs_aa_exp_filt.png", height=5, width=15, dpi=600)
```
```{r}
summary_table_tRNA_T2mild <- data.frame(tRNA=rep(unique(DE_T2_mild_tRNA$ID_DB_cut), each=length(unique(DE_T1_acute_tRNA$tRNA_class))), 
                                         tRNA_type=rep(unique(DE_T1_acute_tRNA$tRNA_class), length(unique(DE_T2_mild_tRNA$ID_DB_cut))), 
                                                       Up="NA", Down="NA")
for (i in 1:nrow(summary_table_tRNA_T2mild)){
  summary_table_tRNA_T2mild$Up[i] <- nrow(DE_T2_mild_tRNA[DE_T2_mild_tRNA$ID_DB_cut==summary_table_tRNA_T2mild$tRNA[i] & 
                                                              DE_T2_mild_tRNA$tRNA_class==summary_table_tRNA_T2mild$tRNA_type[i] & 
                                                              DE_T2_mild_tRNA$lfcShrunk > 0,])
  summary_table_tRNA_T2mild$Down[i] <- nrow(DE_T2_mild_tRNA[DE_T2_mild_tRNA$ID_DB_cut==summary_table_tRNA_T2mild$tRNA[i] & 
                                                              DE_T2_mild_tRNA$tRNA_class==summary_table_tRNA_T2mild$tRNA_type[i] & 
                                                              DE_T2_mild_tRNA$lfcShrunk < 0,])
}
write.table(summary_table_tRNA_T2mild, "/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/summary_table_tRNA_T2_mild.tsv", sep="\t", row.names=FALSE)
```


### 3rd try

Now let's attempt plotting the log2FC values.

First we need to merge the DE_[]_tRNA tables.
```{r}
DE_T1_acute_tRNA$Contrast <- "T1_acute"
DE_T1_mild_tRNA$Contrast <- "T1_mild"
DE_T2_acute_tRNA$Contrast <- "T2_acute"
DE_T2_mild_tRNA$Contrast <- "T2_mild"

DE_FC_tRNA <- rbind(DE_T1_acute_tRNA, DE_T1_mild_tRNA, DE_T2_acute_tRNA, DE_T2_mild_tRNA)
```


For every subtype we have to select the most abundant sequence to get its Log2FC.

#### 5p-tR-half

```{r}
DE_FC_tRNA_5p_tRhalf <- DE_FC_tRNA %>%
  dplyr::filter(DE_FC_tRNA$tRNA_class == "5p-tR-half")

FC_5p_tRhalf <- data.frame(seq=unique(DE_FC_tRNA_5p_tRhalf$ID_DB_cut), T1_acute="NA", 
                           T2_acute="NA", T1_mild="NA", T2_mild="NA",  T1_acute_ID="NA", 
                           T2_acute_ID="NA", T1_mild_ID="NA", T2_mild_ID="NA")
#For each tRNA and each contrast, the seq with the most accumulation must be extracted.

for (aa in FC_5p_tRhalf$seq){
  for (comp in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
    if (nrow(DE_FC_tRNA_5p_tRhalf[DE_FC_tRNA_5p_tRhalf$ID_DB_cut == aa & DE_FC_tRNA_5p_tRhalf$Contrast == comp,]) != 0){
      FC_5p_tRhalf[FC_5p_tRhalf$seq==aa, comp] <- DE_FC_tRNA_5p_tRhalf[DE_FC_tRNA_5p_tRhalf$ID_DB_cut == aa & DE_FC_tRNA_5p_tRhalf$Contrast == comp,] %>% 
        slice_max(baseMean) %>% 
        select(lfcShrunk)
      FC_5p_tRhalf[FC_5p_tRhalf$seq==aa, paste0(comp,"_ID")] <- DE_FC_tRNA_5p_tRhalf[DE_FC_tRNA_5p_tRhalf$ID_DB_cut == aa & DE_FC_tRNA_5p_tRhalf$Contrast == comp,] %>% 
        slice_max(baseMean) %>% 
        select(ID)
    }
    else{
      FC_5p_tRhalf[FC_5p_tRhalf$seq==aa, comp] <- 0
      FC_5p_tRhalf[FC_5p_tRhalf$seq==aa, paste0(comp,"_ID")] <- NA
    }
  }
}
```

Colors
```{r}
myCol = colorRampPalette(c('blue', 'white', 'red'))(100)
myBreaks = seq(-3, 3, length.out = 100)
zscore_col_fun = colorRamp2(myBreaks, myCol)
```

```{r}
FC_5p_tRhalf <- FC_5p_tRhalf %>%
  column_to_rownames(var="seq")

png("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/log2FC_heatmap_5p_tRhalf.png", height = 20, width = 25, res = 1200,units = "cm")
FC_5p_tRhalf_num <- mutate_all(FC_5p_tRhalf[,-c(5,6,7,8)], function(x) as.numeric(as.character(x)))
scaled_matrix_FC_5p_tRhalf <- t(scale(t(FC_5p_tRhalf_num)))
ht_9 <- Heatmap(as.matrix(scaled_matrix_FC_5p_tRhalf),
        show_row_names = TRUE,
        col = zscore_col_fun,
        show_row_dend = FALSE,
        name = "Rel. exp.",
        column_title ="5p-tR-half",
        show_heatmap_legend = TRUE)
draw(ht_9)
dev.off()
```

Eventhough this way of showing the results it's not bad per se, I don't think it adds any layer of information. In words of M. Love "I guess, the point of the heatmap is to visualize the actual counts (normalized and transformed) across samples. There are other, perhaps better ways of visualizing fold changes and p-values (e.g. MA plots for fold changes, and histograms or "volcano" plots for p-values).".


### Accumulation plots

Let's study in more detail what are the accumulation profiles of the tDRs from tRNA Glu and tRNA Gly (the DE sequences which accumulate greater).

```{r}
#Create ID_DB_cut and unique category for 3p-tRF
DE_T1_acute_tRNA$ID_DB_cut <- str_replace(DE_T1_acute_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T1_acute_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T1_acute_tRNA$tRNA_class), "3p-tRF", DE_T1_acute_tRNA$tRNA_class)
DE_T2_acute_tRNA$ID_DB_cut <- str_replace(DE_T2_acute_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T2_acute_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T2_acute_tRNA$tRNA_class), "3p-tRF", DE_T2_acute_tRNA$tRNA_class)
DE_T1_mild_tRNA$ID_DB_cut <- str_replace(DE_T1_mild_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T1_mild_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T1_mild_tRNA$tRNA_class), "3p-tRF", DE_T1_mild_tRNA$tRNA_class)
DE_T2_mild_tRNA$ID_DB_cut <- str_replace(DE_T2_mild_tRNA$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
DE_T2_mild_tRNA$tRNA_class <- ifelse(grepl("CCA", DE_T2_mild_tRNA$tRNA_class), "3p-tRF", DE_T2_mild_tRNA$tRNA_class)
```

### Violin plots

### Glu and Gly

#### 5p-tR-half 
```{r}
sample_RPM_GluGly_5p_tRhalf <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Glu_control=NA, 
                                          Glu_infected=NA, Gly_control=NA, Gly_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
  for (aa in c("Glu", "Gly")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == paste0("tRNA-",aa) & df$tRNA_class == "5p-tR-half",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_GluGly_5p_tRhalf[sample_RPM_GluGly_5p_tRhalf$Group == case, paste0(aa, "_control")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_GluGly_5p_tRhalf[sample_RPM_GluGly_5p_tRhalf$Group == case, paste0(aa, "_infected")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
  }
}

sample_RPM_GluGly_5p_tRhalf_long <- sample_RPM_GluGly_5p_tRhalf%>%
  pivot_longer(c(3:6),
               names_to="Condition",
               values_to="RPM")
sample_RPM_GluGly_5p_tRhalf_long$Color <- ifelse(grepl("control", sample_RPM_GluGly_5p_tRhalf_long$Condition), "Control", paste0(sample_RPM_GluGly_5p_tRhalf_long$Group,"_Infected"))
```

```{r}
sample_RPM_GluGly_5p_tRhalf_long$Group <- factor(sample_RPM_GluGly_5p_tRhalf_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_GluGly_5p_tRhalf_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_GluGly_5p_tRhalf_long$Sample)

ggplot(sample_RPM_GluGly_5p_tRhalf_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2),  alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel(max.overlaps = 50) +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("5p-tR-half") + xlab("")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/GluGly_violin_5p_tRhalf_withlabels.png", height = 5, width = 7)
```

#### 3p-tR-half

```{r}
sample_RPM_GluGly_3p_tRhalf <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Glu_control=NA, 
                                          Glu_infected=NA, Gly_control=NA, Gly_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
  for (aa in c("Glu", "Gly")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == paste0("tRNA-",aa) & df$tRNA_class == "3p-tR-half",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_GluGly_3p_tRhalf[sample_RPM_GluGly_3p_tRhalf$Group == case, paste0(aa, "_control")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_GluGly_3p_tRhalf[sample_RPM_GluGly_3p_tRhalf$Group == case, paste0(aa, "_infected")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
  }
}

sample_RPM_GluGly_3p_tRhalf_long <- sample_RPM_GluGly_3p_tRhalf%>%
  pivot_longer(c(3:6),
               names_to="Condition",
               values_to="RPM")
sample_RPM_GluGly_3p_tRhalf_long$Color <- ifelse(grepl("control", sample_RPM_GluGly_3p_tRhalf_long$Condition), "Control", paste0(sample_RPM_GluGly_3p_tRhalf_long$Group,"_Infected"))
```


```{r}
sample_RPM_GluGly_3p_tRhalf_long$Group <- factor(sample_RPM_GluGly_3p_tRhalf_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_GluGly_3p_tRhalf_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_GluGly_3p_tRhalf_long$Sample)

ggplot(sample_RPM_GluGly_3p_tRhalf_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2), alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel() +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("3p-tR-half") + xlab("") + ylim(c(-1,100))
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/GluGly_violin_3p_tRhalf_withlabels.png", height = 5, width = 7)
```

#### 5p-tRF

```{r}
sample_RPM_GluGly_5p_tRF <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Glu_control=NA, 
                                          Glu_infected=NA, Gly_control=NA, Gly_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
  for (aa in c("Glu", "Gly")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == paste0("tRNA-",aa) & df$tRNA_class == "5p-tRF",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_GluGly_5p_tRF[sample_RPM_GluGly_5p_tRF$Group == case, paste0(aa, "_control")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_GluGly_5p_tRF[sample_RPM_GluGly_5p_tRF$Group == case, paste0(aa, "_infected")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
  }
}

sample_RPM_GluGly_5p_tRF_long <- sample_RPM_GluGly_5p_tRF%>%
  pivot_longer(c(3:6),
               names_to="Condition",
               values_to="RPM")
sample_RPM_GluGly_5p_tRF_long$Color <- ifelse(grepl("control", sample_RPM_GluGly_5p_tRF_long$Condition), "Control", paste0(sample_RPM_GluGly_5p_tRF_long$Group,"_Infected"))
```

```{r}
sample_RPM_GluGly_5p_tRF_long$Group <- factor(sample_RPM_GluGly_5p_tRF_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_GluGly_5p_tRF_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_GluGly_5p_tRF_long$Sample)

ggplot(sample_RPM_GluGly_5p_tRF_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2), alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel() +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("5p-tRF") + xlab("") + ylim(c(-1,6000))
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/GluGly_violin_5p_tRF_withlabel.png", height = 5, width = 7)
```

#### 3-tRF

```{r}
sample_RPM_GluGly_3p_tRF <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Glu_control=NA, 
                                          Glu_infected=NA, Gly_control=NA, Gly_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
  for (aa in c("Glu", "Gly")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == paste0("tRNA-",aa) & df$tRNA_class == "3p-tRF",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_GluGly_3p_tRF[sample_RPM_GluGly_3p_tRF$Group == case, paste0(aa, "_control")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_GluGly_3p_tRF[sample_RPM_GluGly_3p_tRF$Group == case, paste0(aa, "_infected")] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
  }
}

sample_RPM_GluGly_3p_tRF_long <- sample_RPM_GluGly_3p_tRF%>%
  pivot_longer(c(3:6),
               names_to="Condition",
               values_to="RPM")
sample_RPM_GluGly_3p_tRF_long$Color <- ifelse(grepl("control", sample_RPM_GluGly_3p_tRF_long$Condition), "Control", paste0(sample_RPM_GluGly_3p_tRF_long$Group,"_Infected"))
```

```{r}
sample_RPM_GluGly_3p_tRF_long$Group <- factor(sample_RPM_GluGly_3p_tRF_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_GluGly_3p_tRF_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_GluGly_3p_tRF_long$Sample)

ggplot(sample_RPM_GluGly_3p_tRF_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2), alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel() +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("3p-tRF") + xlab("") + ylim(c(-1,100))
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/GluGly_violin_3p_tRF_withlabels.png", height = 5, width = 7)
```

### Val

#### 5p-tR-half

```{r}
sample_RPM_Val_5p_tRhalf <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Val_control=NA, 
                                          Val_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == "tRNA-Val" & df$tRNA_class == "5p-tR-half",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_Val_5p_tRhalf[sample_RPM_Val_5p_tRhalf$Group == case, "Val_control"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_Val_5p_tRhalf[sample_RPM_Val_5p_tRhalf$Group == case, "Val_infected"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
}


sample_RPM_Val_5p_tRhalf_long <- sample_RPM_Val_5p_tRhalf%>%
  pivot_longer(c(3:4),
               names_to="Condition",
               values_to="RPM")
sample_RPM_Val_5p_tRhalf_long$Color <- ifelse(grepl("control", sample_RPM_Val_5p_tRhalf_long$Condition), "Control", paste0(sample_RPM_Val_5p_tRhalf_long$Group,"_Infected"))
```

```{r}
sample_RPM_Val_5p_tRhalf_long$Group <- factor(sample_RPM_Val_5p_tRhalf_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_Val_5p_tRhalf_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_Val_5p_tRhalf_long$Sample)

ggplot(sample_RPM_Val_5p_tRhalf_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2),  alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel(max.overlaps = 50) +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("5p-tR-half") + xlab("")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/Val_violin_5p_tRhalf.png", height = 5, width = 7)
```

#### 5p-tR-half

```{r}
sample_RPM_Val_3p_tRhalf <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Val_control=NA, 
                                          Val_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == "tRNA-Val" & df$tRNA_class == "3p-tR-half",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_Val_3p_tRhalf[sample_RPM_Val_3p_tRhalf$Group == case, "Val_control"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_Val_3p_tRhalf[sample_RPM_Val_3p_tRhalf$Group == case, "Val_infected"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
}


sample_RPM_Val_3p_tRhalf_long <- sample_RPM_Val_3p_tRhalf%>%
  pivot_longer(c(3:4),
               names_to="Condition",
               values_to="RPM")
sample_RPM_Val_3p_tRhalf_long$Color <- ifelse(grepl("control", sample_RPM_Val_3p_tRhalf_long$Condition), "Control", paste0(sample_RPM_Val_3p_tRhalf_long$Group,"_Infected"))
```

```{r}
sample_RPM_Val_3p_tRhalf_long$Group <- factor(sample_RPM_Val_3p_tRhalf_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_Val_3p_tRhalf_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_Val_3p_tRhalf_long$Sample)

ggplot(sample_RPM_Val_3p_tRhalf_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2),  alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel(max.overlaps = 50) +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("3p-tR-half") + xlab("")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/Val_violin_3p_tRhalf.png", height = 5, width = 7)
```

#### 5p-tRF

```{r}
sample_RPM_Val_5p_tRF <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Val_control=NA, 
                                          Val_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == "tRNA-Val" & df$tRNA_class == "5p-tRF",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_Val_5p_tRF[sample_RPM_Val_5p_tRF$Group == case, "Val_control"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_Val_5p_tRF[sample_RPM_Val_5p_tRF$Group == case, "Val_infected"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
}

sample_RPM_Val_5p_tRF_long <- sample_RPM_Val_5p_tRF%>%
  pivot_longer(c(3:4),
               names_to="Condition",
               values_to="RPM")
sample_RPM_Val_5p_tRF_long$Color <- ifelse(grepl("control", sample_RPM_Val_5p_tRF_long$Condition), "Control", paste0(sample_RPM_Val_5p_tRF_long$Group,"_Infected"))
```

```{r}
sample_RPM_Val_5p_tRF_long$Group <- factor(sample_RPM_Val_5p_tRF_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_Val_5p_tRF_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_Val_5p_tRF_long$Sample)

ggplot(sample_RPM_Val_5p_tRF_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2),  alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel(max.overlaps = 50) +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("5p-tRF") + xlab("")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/Val_violin_5p_tRF.png", height = 5, width = 7)
```

#### 3p-tRF

```{r}
sample_RPM_Val_3p_tRF <- data.frame(Sample=sampletable$SampleName[-c(1:8)], Group=sampletable$Group[-c(1:8)], Val_control=NA, 
                                          Val_infected=NA)

for (case in c("T1_acute", "T1_mild", "T2_acute", "T2_mild")){
    df <- get(paste0("DE_", case, "_tRNA"))
    df_subset <- df[df$ID_DB_cut == "tRNA-Val" & df$tRNA_class == "3p-tRF",]
    seqs <- df_subset$seq
    col_control <- colnames(RPMs_table)[which(grepl("control", colnames(RPMs_table)))]
    col_case <- colnames(RPMs_table)[which(grepl(case, colnames(RPMs_table)))]
    df_RPM <- RPMs_table[RPMs_table$seq %in% seqs, c("seq",col_control,col_case)]
    df_RPM <- df_RPM %>% #Sum every seq
      bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))
    sample_RPM_Val_3p_tRF[sample_RPM_Val_3p_tRF$Group == case, "Val_control"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl("control", colnames(df_RPM))])
    sample_RPM_Val_3p_tRF[sample_RPM_Val_3p_tRF$Group == case, "Val_infected"] <- as.numeric(df_RPM[df_RPM$seq == "Total", grepl(case, colnames(df_RPM))])
}

sample_RPM_Val_3p_tRF_long <- sample_RPM_Val_3p_tRF%>%
  pivot_longer(c(3:4),
               names_to="Condition",
               values_to="RPM")
sample_RPM_Val_3p_tRF_long$Color <- ifelse(grepl("control", sample_RPM_Val_3p_tRF_long$Condition), "Control", paste0(sample_RPM_Val_3p_tRF_long$Group,"_Infected"))
```

```{r}
sample_RPM_Val_3p_tRF_long$Group <- factor(sample_RPM_Val_3p_tRF_long$Group, levels = c("T1_acute", "T2_acute", "T1_mild", "T2_mild"))
state.labs <- c("Severe (T1)", "Severe (T2)", "Moderate (T1)", "Moderate (T2)")
names(state.labs) <- c("T1_acute", "T2_acute", "T1_mild", "T2_mild")
sample_RPM_Val_3p_tRF_long$Label <- gsub("T[012]\\_(acute|mild|control)-", "", sample_RPM_Val_3p_tRF_long$Sample)

ggplot(sample_RPM_Val_3p_tRF_long, aes(x=Condition, y=RPM, fill=Color, color=Color)) +
  geom_violin(alpha=0.7) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2),  alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "lightgreen", "#ED0000B2", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "lightgreen","#ED0000B2", "darkgreen")) +
  #geom_text_repel(max.overlaps = 50) +
  theme_classic() +
  facet_wrap(~Group, nrow = 1, strip.position = "bottom", labeller = labeller(Group=state.labs)) +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank()) + ggtitle("3p-tRF") + xlab("")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/Val_violin_3p_tRF.png", height = 5, width = 7)
```
***

### Supp. figure

We need an initial figure showing that the preponderant tRNA species (in terms of accumulation) are tRNA-Glu and tRNA-Gly.

####Severe
```{r}
df_tRNA_acute <- data.frame(Sample=rep(colnames(RPMs_table)[c(2:17, 26:33)], length(aa_list)), 
                            tRNA_isotype=rep(aa_list, each=length(colnames(RPMs_table)[c(2:17, 26:33)])),
                            Group=rep(rep(c("Control", "T1", "T2"), each=8), 20), RPM=NA)
```

```{r}
DE_tRNAs_acute <- Reduce (union, list(DE_T1_acute_tRNA$seq, DE_T2_acute_tRNA$seq))

RPMs_table_acuteDE <- RPMs_table %>%
  dplyr::filter(seq %in% DE_tRNAs_acute)

RPMs_table_acuteDE_ann <- merge(RPMs_table_acuteDE, anno_file, by.x="seq", by.y="Seq", all.x=TRUE)
RPMs_table_acuteDE_ann$ID_DB_cut <- str_replace(RPMs_table_acuteDE_ann$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")

#Filter the samples
RPMs_table_acuteDE_ann <- RPMs_table_acuteDE_ann[,c(which(grepl("control|acute",colnames(RPMs_table_acuteDE_ann))), c(42:48))]

for (aa in aa_list){
  df_tRNA_acute[df_tRNA_acute$tRNA_isotype == aa, "RPM"] <- t(RPMs_table_acuteDE_ann[RPMs_table_acuteDE_ann$ID_DB_cut == aa, c(1:24)] %>% summarise_all(sum))
}

df_tRNA_acute$tRNA_isotype <- str_replace(df_tRNA_acute$tRNA_isotype, "tRNA-", "")
```

```{r}
ggplot(df_tRNA_acute, aes(x=Group, y=RPM, fill=Group, color=Group)) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2), alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "#da6a65", "#ED0000B2")) +
  scale_color_manual(values=c("#00468BB2", "#da6a65", "#ED0000B2")) +
  facet_wrap(~ tRNA_isotype, nrow = 1, strip.position = "bottom") +
  theme_classic() +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank())

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/tRNA_isotype_accumulation_severe.png", height=7, width=15)
```
For the paper we need to facilitate the exact number of the medians:

```{r}
median(df_tRNA_acute[df_tRNA_acute$tRNA_isotype == "Glu" & df_tRNA_acute$Group == "T1", "RPM"])
median(df_tRNA_acute[df_tRNA_acute$tRNA_isotype == "Glu" & df_tRNA_acute$Group == "T2", "RPM"])
median(df_tRNA_acute[df_tRNA_acute$tRNA_isotype == "Gly" & df_tRNA_acute$Group == "T1", "RPM"])
median(df_tRNA_acute[df_tRNA_acute$tRNA_isotype == "Gly" & df_tRNA_acute$Group == "T2", "RPM"])
```

#### Moderate
```{r}
df_tRNA_mild <- data.frame(Sample=rep(colnames(RPMs_table)[c(2:9, 18:25, 34:41)], length(aa_list)), 
                            tRNA_isotype=rep(aa_list, each=length(colnames(RPMs_table)[c(2:9, 18:25, 34:41)])),
                            Group=rep(rep(c("Control", "T1", "T2"), each=8), 20), RPM=NA)
```

```{r}
DE_tRNAs_mild <- Reduce (union, list(DE_T1_mild_tRNA$seq, DE_T2_mild_tRNA$seq))

RPMs_table_mildDE <- RPMs_table %>%
  dplyr::filter(seq %in% DE_tRNAs_mild)

RPMs_table_mildDE_ann <- merge(RPMs_table_mildDE, anno_file, by.x="seq", by.y="Seq", all.x=TRUE)
RPMs_table_mildDE_ann$ID_DB_cut <- str_replace(RPMs_table_mildDE_ann$RNA_ID, "-[A-Z]{3}-[0-9][0-9]?-[0-9][0-9]?", "")
#Filter the samples
RPMs_table_mildDE_ann <- RPMs_table_mildDE_ann[,c(which(grepl("control|mild",colnames(RPMs_table_mildDE_ann))), c(42:48))]

for (aa in aa_list){
  df_tRNA_mild[df_tRNA_mild$tRNA_isotype == aa, "RPM"] <- t(RPMs_table_mildDE_ann[RPMs_table_mildDE_ann$ID_DB_cut == aa, c(1:24)] %>% summarise_all(sum))
}

df_tRNA_mild$tRNA_isotype <- str_replace(df_tRNA_mild$tRNA_isotype, "tRNA-", "")
```

```{r}
ggplot(df_tRNA_mild, aes(x=Group, y=RPM, fill=Group, color=Group)) +
  geom_boxplot(width=0.25, outlier.shape = NA, alpha=0.7, color="black") +
  geom_jitter(position=position_jitter(0.2), alpha=0.7) +
  scale_fill_manual(values=c("#00468BB2", "lightgreen", "darkgreen")) +
  scale_color_manual(values=c("#00468BB2", "lightgreen", "darkgreen")) +
  scale_y_break(c(125000,210000)) +
  facet_wrap(~ tRNA_isotype, nrow = 1, strip.position = "bottom") +
  theme_classic() +
  theme(legend.position="none",
        plot.title = element_text(size = rel(2)),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1, color="black", size=10),
        axis.text.y = element_text(color="black", size=10),
        panel.grid = element_blank(),
        strip.background = element_rect(fill="#ebeff1"),
        strip.text = element_text(size=10),
        panel.border = element_blank(),
        axis.line.y = element_line(color="black"),
        axis.line.x = element_blank())

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/tRNA_isotype_accumulation_moderate.png", height=7, width=15)
```

```{r}
median(df_tRNA_mild[df_tRNA_mild$tRNA_isotype == "Glu" & df_tRNA_mild$Group == "T1", "RPM"])
median(df_tRNA_mild[df_tRNA_mild$tRNA_isotype == "Glu" & df_tRNA_mild$Group == "T2", "RPM"])
median(df_tRNA_mild[df_tRNA_mild$tRNA_isotype == "Gly" & df_tRNA_mild$Group == "T1", "RPM"])
median(df_tRNA_mild[df_tRNA_mild$tRNA_isotype == "Gly" & df_tRNA_mild$Group == "T2", "RPM"])
```

***

Misc-tRF analysis.

#### T1 acute
```{r}
DE_T1_acute_tRNA_misc <- DE_T1_acute_tRNA[DE_T1_acute_tRNA$tRNA_class == "misc-tRF",]
```

Length distribution
```{r}
DE_T1_acute_misc_length <- DE_T1_acute_tRNA_misc %>% 
  dplyr::count(Length, ID_DB_cut)

ggplot(DE_T1_acute_misc_length, aes(x=Length, y=n)) +
  geom_bar(position="dodge", stat="identity", fill= "#da6a65", alpha=0.7) +
  scale_x_continuous(breaks=seq(2,34)) +
  facet_wrap(~ ID_DB_cut) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T1) misc-tRNA length distribution")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_acute_misc_lengthdist.png", width=10, height=10)
```
Start position distribution.
```{r}
DE_T1_acute_tRNA_misc$Start <- gsub("\\(", "", DE_T1_acute_tRNA_misc$Position)
DE_T1_acute_tRNA_misc$Start <- gsub("\\-.+\\)", "", DE_T1_acute_tRNA_misc$Start)
```

```{r}
DE_T1_acute_misc_start <- DE_T1_acute_tRNA_misc %>% 
  dplyr::count(Start, ID_DB_cut)

DE_T1_acute_misc_start$Start <- as.numeric(DE_T1_acute_misc_start$Start)

ggplot(DE_T1_acute_misc_start, aes(x=Start, y=n)) +
  geom_bar(position="dodge", stat="identity", fill= "#da6a65", alpha=0.7) +
  facet_wrap(~ ID_DB_cut, ncol=2) +
  scale_x_continuous(breaks=seq(2,71)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T1) start position of misc-tRNA") 
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_acute_misc_startpos.png", width=16, height=10)
```

Balloon plot showing diversity of sequences and accumulation (baseMean) of those sequences.
```{r}
T1_acute_balloon <- data.frame(tRNA=aa_list, N=NA, RPM=NA)

#Dataframe which stores the number of different misc-tRNA per tRNA and its accumulation
for (aa in T1_acute_balloon$tRNA){
  subset_df <- DE_T1_acute_tRNA_misc[DE_T1_acute_tRNA_misc$ID_DB_cut == aa, "baseMean"]
  n_seqs <- length(subset_df)
  accum <- sum(subset_df)
  T1_acute_balloon[T1_acute_balloon$tRNA == aa, "N"] <- n_seqs
  T1_acute_balloon[T1_acute_balloon$tRNA == aa, "RPM"] <- accum
}

T1_acute_balloon$N <- factor(T1_acute_balloon$N, levels=seq(0,31))
```

```{r}
ggballoonplot(T1_acute_balloon, x="N", y="tRNA", size="RPM", fill="#da6a65") +
  scale_x_discrete(drop=FALSE)

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_acute_misc_balloon.png", width=7.5, height=6)
```

#### T2 acute
```{r}
DE_T2_acute_tRNA_misc <- DE_T2_acute_tRNA[DE_T2_acute_tRNA$tRNA_class == "misc-tRF",]
```

Length distribution
```{r}
DE_T2_acute_misc_length <- DE_T2_acute_tRNA_misc %>% 
  dplyr::count(Length, ID_DB_cut)

ggplot(DE_T2_acute_misc_length, aes(x=Length, y=n)) +
  geom_bar(position="dodge", stat="identity", fill="#ED0000B2", alpha=0.7) +
  scale_x_continuous(breaks=seq(2,34)) +
  facet_wrap(~ ID_DB_cut) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T2) misc-tRNA length distribution")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_acute_misc_lengthdist.png", width=10, height=10)
```

Start position distribution.
```{r}
DE_T2_acute_tRNA_misc$Start <- gsub("\\(", "", DE_T2_acute_tRNA_misc$Position)
DE_T2_acute_tRNA_misc$Start <- gsub("\\-.+\\)", "", DE_T2_acute_tRNA_misc$Start)
```

```{r}
DE_T2_acute_misc_start <- DE_T2_acute_tRNA_misc %>% 
  dplyr::count(Start, ID_DB_cut)

DE_T2_acute_misc_start$Start <- as.numeric(DE_T2_acute_misc_start$Start)

ggplot(DE_T2_acute_misc_start, aes(x=Start, y=n)) +
  geom_bar(position="dodge", stat="identity", fill= "#ED0000B2", alpha=0.7) +
  facet_wrap(~ ID_DB_cut, ncol=2) +
  scale_x_continuous(breaks=seq(2,71)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T2) start position of misc-tRNA") 
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_acute_misc_startpos.png", width=16, height=10)
```

Balloon plot showing diversity of sequences and accumulation (baseMean) of those sequences.
```{r}
T2_acute_balloon <- data.frame(tRNA=aa_list, N=NA, RPM=NA)

#Dataframe which stores the number of different misc-tRNA per tRNA and its accumulation
for (aa in T2_acute_balloon$tRNA){
  subset_df <- DE_T2_acute_tRNA_misc[DE_T2_acute_tRNA_misc$ID_DB_cut == aa, "baseMean"]
  n_seqs <- length(subset_df)
  accum <- sum(subset_df)
  T2_acute_balloon[T2_acute_balloon$tRNA == aa, "N"] <- n_seqs
  T2_acute_balloon[T2_acute_balloon$tRNA == aa, "RPM"] <- accum
}

T2_acute_balloon$N <- factor(T2_acute_balloon$N, levels=seq(0,31))
```

```{r}
ggballoonplot(T2_acute_balloon, x="N", y="tRNA", size="RPM", fill="#ED0000B2") +
  scale_x_discrete(drop=FALSE)

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_acute_misc_balloon.png", width=7.5, height=6)
```


#### T1 mild

```{r}
DE_T1_mild_tRNA_misc <- DE_T1_mild_tRNA[DE_T1_mild_tRNA$tRNA_class == "misc-tRF",]
```

Length distribution
```{r}
DE_T1_mild_misc_length <- DE_T1_mild_tRNA_misc %>% 
  dplyr::count(Length, ID_DB_cut)

ggplot(DE_T1_mild_misc_length, aes(x=Length, y=n)) +
  geom_bar(position="dodge", stat="identity", fill= "lightgreen", alpha=0.7) +
  scale_x_continuous(breaks=seq(2,34)) +
  facet_wrap(~ ID_DB_cut) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T1) misc-tRNA length distribution")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_mild_misc_lengthdist.png", width=10, height=10)
```

Start position distribution.
```{r}
DE_T1_mild_tRNA_misc$Start <- gsub("\\(", "", DE_T1_mild_tRNA_misc$Position)
DE_T1_mild_tRNA_misc$Start <- gsub("\\-.+\\)", "", DE_T1_mild_tRNA_misc$Start)
```

```{r}
DE_T1_mild_misc_start <- DE_T1_mild_tRNA_misc %>% 
  dplyr::count(Start, ID_DB_cut)

DE_T1_mild_misc_start$Start <- as.numeric(DE_T1_mild_misc_start$Start)

ggplot(DE_T1_mild_misc_start, aes(x=Start, y=n)) +
  geom_bar(position="dodge", stat="identity", fill="lightgreen", alpha=0.7) +
  facet_wrap(~ ID_DB_cut, ncol=2) +
  scale_x_continuous(breaks=seq(2,71)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T1) start position of misc-tRNA") 
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_mild_misc_startpos.png", width=16, height=10)
```

Balloon plot showing diversity of sequences and accumulation (baseMean) of those sequences.
```{r}
T1_mild_balloon <- data.frame(tRNA=aa_list, N=NA, RPM=NA)

#Dataframe which stores the number of different misc-tRNA per tRNA and its accumulation
for (aa in T1_mild_balloon$tRNA){
  subset_df <- DE_T1_mild_tRNA_misc[DE_T1_mild_tRNA_misc$ID_DB_cut == aa, "baseMean"]
  n_seqs <- length(subset_df)
  accum <- sum(subset_df)
  T1_mild_balloon[T1_mild_balloon$tRNA == aa, "N"] <- n_seqs
  T1_mild_balloon[T1_mild_balloon$tRNA == aa, "RPM"] <- accum
}

T1_mild_balloon$N <- factor(T1_mild_balloon$N, levels=seq(0,31))
```

```{r}
ggballoonplot(T1_mild_balloon, x="N", y="tRNA", size="RPM", fill="lightgreen") +
  scale_x_discrete(drop=FALSE)

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T1_mild_misc_balloon.png", width=7.5, height=6)
```


#### T2 mild

```{r}
DE_T2_mild_tRNA_misc <- DE_T2_mild_tRNA[DE_T2_mild_tRNA$tRNA_class == "misc-tRF",]
```

Length distribution
```{r}
DE_T2_mild_misc_length <- DE_T2_mild_tRNA_misc %>% 
  dplyr::count(Length, ID_DB_cut)

ggplot(DE_T2_mild_misc_length, aes(x=Length, y=n)) +
  geom_bar(position="dodge", stat="identity", fill= "darkgreen", alpha=0.7) +
  scale_x_continuous(breaks=seq(2,34)) +
  facet_wrap(~ ID_DB_cut) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T2) misc-tRNA length distribution")
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_mild_misc_lengthdist.png", width=10, height=10)
```

Start position distribution.
```{r}
DE_T2_mild_tRNA_misc$Start <- gsub("\\(", "", DE_T2_mild_tRNA_misc$Position)
DE_T2_mild_tRNA_misc$Start <- gsub("\\-.+\\)", "", DE_T2_mild_tRNA_misc$Start)
```

```{r}
DE_T2_mild_misc_start <- DE_T2_mild_tRNA_misc %>% 
  dplyr::count(Start, ID_DB_cut)

DE_T2_mild_misc_start$Start <- as.numeric(DE_T2_mild_misc_start$Start)

ggplot(DE_T2_mild_misc_start, aes(x=Start, y=n)) +
  geom_bar(position="dodge", stat="identity", fill="darkgreen", alpha=0.7) +
  facet_wrap(~ ID_DB_cut, ncol=2) +
  scale_x_continuous(breaks=seq(2,71)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle=90)) + ggtitle("Severe (T2) start position of misc-tRNA") 
ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_mild_misc_startpos.png", width=16, height=10)
```

Balloon plot showing diversity of sequences and accumulation (baseMean) of those sequences.
```{r}
T2_mild_balloon <- data.frame(tRNA=aa_list, N=NA, RPM=NA)

#Dataframe which stores the number of different misc-tRNA per tRNA and its accumulation
for (aa in T2_mild_balloon$tRNA){
  subset_df <- DE_T2_mild_tRNA_misc[DE_T2_mild_tRNA_misc$ID_DB_cut == aa, "baseMean"]
  n_seqs <- length(subset_df)
  accum <- sum(subset_df)
  T2_mild_balloon[T2_mild_balloon$tRNA == aa, "N"] <- n_seqs
  T2_mild_balloon[T2_mild_balloon$tRNA == aa, "RPM"] <- accum
}

T2_mild_balloon$N <- factor(T2_mild_balloon$N, levels=seq(0,31))
```

```{r}
ggballoonplot(T2_mild_balloon, x="N", y="tRNA", size="RPM", fill="darkgreen") +
  scale_x_discrete(drop=FALSE)

ggsave("/home/ultramind/Disco2/SARS_sRNA_paper/Results/11-tRNA_analysis/T2_mild_misc_balloon.png", width=7.5, height=6)
```

