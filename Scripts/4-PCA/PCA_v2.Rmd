---
title: "PCA_v2"
author: "Julia Corell"
date: "23/4/2021"
output: html_document
---

The aim of this script is to build a PCA containing all the samples of the SARS-CoV-2 study, i.e. for the different groups (control, acute and mild) and for the different times (T0, T1 and T2) all replicates must be present. As input data, the table generated by the script 01-Prepare_fasta_libraries_and_count_tables_multiprocessing_v2.py will be used, namely: Fusion_abs-inner.csv.

The PCAs will allow us to see mainly if there are differences between the replicas of the same group and time, which should be grouped together in the PCA and; to see how the libraries of the different times and groups are distributed in a three-dimensional space.

### 0. LOAD THE LIBRARIES AND SET THE OPTIONS

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
#options(rgl.useNULL=TRUE)
library(rgl)
#options(rgl.printRglwidget = TRUE)
setupKnitr(autoprint = TRUE)
knit_hooks$set(webgl = hook_webgl)
knitr.duplicate.label = "allow"
```

```{r}
library(tidyverse)
library(stats)
library(factoextra)
library(ggfortify)
library(DESeq2)
```

```{r}
sampletable <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Additional_data/samplesheet.tsv", header=T, sep="\t")

counts_table <- read.table("/home/ultramind/Disco2/SARS_sRNA_paper/Results/03-Fusion_tables/Fusion_abs-inner.csv",  header=T, sep=",")
counts_table <- counts_table %>%
  column_to_rownames(var="seq")

counts_table[is.na(counts_table)] <- 0
```

Following the vignette of DESeq2 "Many common statistical methods for exploratory analysis of multidimensional data, for example clustering and principal components analysis (PCA), work best for data that generally has the same range of variance at different ranges of the mean values. [...] As a solution, DESeq2 offers two transformations for count data that stabilize the variance across the mean: the variance stabilizing transformation (VST) for negative binomial data with a dispersion-mean trend (Anders and Huber 2010), implemented in the vst function, and the regularized-logarithm transformation or rlog (Love, Huber, and Anders 2014)."
```{r}
sampletable$Age_group <- NA
sampletable$Age_group <- cut(sampletable$Age, 4, labels = FALSE)

dds <- DESeqDataSetFromMatrix(countData = counts_table,
                                 colData = sampletable,
                                 design = ~ Group)
rm(counts_table)
dds$Age_group <- factor(dds$Age_group, c(1,2,3,4))
dds$Group <- relevel(dds$Group, ref ="T0_control")
#dds2 <- DESeq(dds)
vst_dds <- assay(vst(dds, blind=TRUE))
#vst_3d <- vst(dds, blind=TRUE)
```


```{r}
vst_pca <- prcomp(t(vst_dds))
fviz_eig(vst_pca, addlabels=TRUE)
```


```{r}
## Convert to dataframe and add a color column and a names columns (sample names)
df_vst = as.data.frame(vst_pca$x)

## Add the color.
df_vst$color = c(rep("#00468BB2",8), #T0_control --> Azul.
              rep("#da6a65",8), #T1_acute --> Rojo claro
              rep("lightgreen",8), #T1_mild --> Verde claro
              rep("#ED0000B2",8), #T2_acute --> Rojo oscuro
              rep("darkgreen",8)) #T2_mild --> Verde oscuro
        

## Plot the PCA
with(df_vst, par3d(ignoreExtent=F))
with(df_vst,plot3d(df_vst$PC1, df_vst$PC2, df_vst$PC3, col=df_vst$color,type="s", radius=12, alpha=1, 
               xlab = "", ylab = "", zlab = "", shininess=20, axes=F))

with(df_vst, box3d())
with(df_vst, axis3d('x--',labels=T,tick=T))
with(df_vst, axis3d('y+-',labels=T,tick=T))
with(df_vst, axis3d('z++',labels=T,tick=T))

with(df_vst, par3d(ignoreExtent=T))
with(df_vst,aspect3d(1, 1, 1))
with(df_vst,title3d(main = '', sub = NULL, 
                xlab = "PC1", ylab = "PC2", color = "black",
                zlab = "PC3", font = 2))

```
